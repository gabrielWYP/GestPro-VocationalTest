name: Deploy en VM Privada

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted  # <--- Esto busca tu runner en la VM
    
    steps:
      # 1. El runner descarga el cÃ³digo nuevo del repo
      - name: Tomar cÃ³digo mÃ¡s reciente
        uses: actions/checkout@v4

      # 2. Copiar archivos a la carpeta de producciÃ³n
      - name: Desplegar archivos
        run: |
          echo "ðŸš€ Iniciando despliegue en /mnt/tesis_data/proyecto-prod..."
          
          # Limpiar carpeta PRD completamente (excepto .env si existe)
          echo "ðŸ§¹ Limpiando carpeta de destino..."
          if [ -d /mnt/tesis_data/codigo/vocational_test_prd ]; then
            # Guardar .env si existe (contiene secretos)
            if [ -f /mnt/tesis_data/codigo/vocational_test_prd/.env ]; then
              cp /mnt/tesis_data/codigo/vocational_test_prd/.env /tmp/.env.backup
            fi
            
            # Eliminar todo en PRD
            rm -rf /mnt/tesis_data/codigo/vocational_test_prd/*
            rm -rf /mnt/tesis_data/codigo/vocational_test_prd/.github
            rm -rf /mnt/tesis_data/codigo/vocational_test_prd/.git
            
            # Restaurar .env si lo guardamos
            if [ -f /tmp/.env.backup ]; then
              cp /tmp/.env.backup /mnt/tesis_data/codigo/vocational_test_prd/.env
              rm /tmp/.env.backup
            fi
          else
            mkdir -p /mnt/tesis_data/codigo/vocational_test_prd
          fi
          
          # Copiar archivos de DEV a PRD (espejo exacto, sin .git ni .github)
          echo "ðŸ“¦ Copiando archivos desde DEV a PRD..."
          rsync -av --exclude='.git' --exclude='.github' --exclude='.env' ./ /mnt/tesis_data/codigo/vocational_test_prd/
          
          echo "âœ… Archivos copiados exitosamente (carpeta reemplazada)."

      # 3. Build & Deploy con docker-compose
      - name: Build & Deploy Docker
        env:
          # Leer secretos de GitHub y pasarlos como variables de entorno
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
          ORACLE_PASSWORD: ${{ secrets.ORACLE_PASSWORD }}
          ORACLE_CONNECTION_STRING: ${{ secrets.ORACLE_CONNECTION_STRING }}
        run: |
          set -e  # Salir si hay algÃºn error
          
          echo "ðŸ³ Iniciando proceso Docker con compose..."
          cd /mnt/tesis_data/codigo/vocational_test_prd
          
          # PASO 0: Respaldar imagen anterior (rollback)
          BACKUP_IMAGE="vocational_test_dev-vocational-test:backup"
          CURRENT_IMAGE="vocational_test_dev-vocational-test:latest"
          
          echo "ðŸ’¾ Respaldando imagen anterior..."
          if sudo docker images | grep -q "$CURRENT_IMAGE"; then
            sudo docker tag $CURRENT_IMAGE $BACKUP_IMAGE || true
            echo "âœ… Imagen respaldada como: $BACKUP_IMAGE"
          else
            echo "âš ï¸  Primera vez, no hay imagen anterior para respaldar"
          fi
          
          # Crear archivo .env en producciÃ³n con los secretos de GitHub
          cat > .env << EOF
          ORACLE_USER=${ORACLE_USER}
          ORACLE_PASSWORD=${ORACLE_PASSWORD}
          ORACLE_CONNECTION_STRING=${ORACLE_CONNECTION_STRING}
          EOF
          
          # PASO 1: Detener contenedor viejo
          echo "ðŸ›‘ Deteniendo contenedor anterior..."
          sudo docker compose down || true
          
          # PASO 2: Build de la nueva imagen
          echo "ðŸ”¨ Construyendo nueva imagen..."
          if ! sudo docker compose build --no-cache; then
            echo "âŒ ERROR: Fallo en build de imagen"
            echo "ðŸ”„ Restaurando imagen anterior..."
            sudo docker tag $BACKUP_IMAGE $CURRENT_IMAGE || true
            exit 1
          fi
          echo "âœ… Build exitoso"
          
          # PASO 3: Levantar nuevo contenedor
          echo "ðŸš€ Iniciando nuevo contenedor..."
          if ! sudo docker compose up -d; then
            echo "âŒ ERROR: Fallo al iniciar contenedor"
            echo "ðŸ”„ Restaurando imagen anterior..."
            sudo docker tag $BACKUP_IMAGE $CURRENT_IMAGE || true
            exit 1
          fi
          echo "âœ… Contenedor iniciado"
          
          # PASO 4: Validar healthcheck (mÃ¡x 30s)
          echo "â³ Esperando healthcheck..."
          HEALTHCHECK_PASSED=false
          for i in {1..30}; do
            if sudo docker compose ps | grep -q "healthy"; then
              echo "âœ… Contenedor saludable"
              HEALTHCHECK_PASSED=true
              break
            fi
            echo "â³ Intento $i/30..."
            sleep 1
          done
          
          # PASO 5: Si healthcheck falla, hacer rollback
          if [ "$HEALTHCHECK_PASSED" = false ]; then
            echo "âŒ ERROR CRÃTICO: Healthcheck fallÃ³ despuÃ©s de 30 segundos"
            echo "ðŸ”„ Iniciando rollback a imagen anterior..."
            
            # Detener contenedor fallido
            sudo docker compose down || true
            
            # Restaurar imagen anterior
            sudo docker tag $BACKUP_IMAGE $CURRENT_IMAGE || true
            
            # Levantar contenedor con imagen anterior
            echo "ðŸ“¦ Levantando contenedor con imagen respaldada..."
            if sudo docker compose up -d; then
              echo "âœ… Rollback completado - Servicio restaurado"
              # Notificar
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âš ï¸  DEPLOY FALLIDO - ROLLBACK COMPLETADO"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "Imagen nueva no pasÃ³ healthcheck"
              echo "Se ha restaurado la versiÃ³n anterior"
              echo "Verifica los logs del contenedor:"
              echo "  docker logs vocational-test-app"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            else
              echo "âŒ CRÃTICO: Rollback fallÃ³ - Servicio sin imagen"
              exit 1
            fi
            exit 1
          fi
          
          # PASO 6: Limpiar .env despuÃ©s de deploy (por seguridad)
          rm -f .env
          
          # PASO 7: Limpieza de imÃ¡genes viejas
          echo "ðŸ§¹ Limpiando imÃ¡genes antiguas..."
          sudo docker image prune -f
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY EXITOSO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Nueva imagen deployada y validada"
          echo "Contenedor corriendo correctamente"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
